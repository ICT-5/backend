<!-- src/main/resources/static/index.html -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>RAG 분석</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; }
    body { margin: 24px; background: #f8fafc; color: #0f172a; }
    h1 { margin: 0 0 16px; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 980px) { .grid { grid-template-columns: 420px 1fr; } }

    .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display: grid; grid-template-columns: 140px 1fr; gap: 12px; align-items: center; margin-bottom: 10px; }
    label { font-weight: 600; color: #334155; }
    input[type="text"], input[type="number"], input[type="url"], input[type="file"] {
      width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: #fff;
    }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background: #2563eb; color: #fff; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 12px; color: #64748b; }
    .cols { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 1200px) { .cols { grid-template-columns: 1fr 1fr; } }

    .kvs { margin: 0 0 8px; padding: 0; list-style: none; font-size: 14px; color:#475569;}
    .kvs li{ margin:2px 0}
    .mono { white-space: pre-wrap; word-break: break-word; background: #0b1020; color: #e2e8f0; padding: 14px; border-radius: 10px; overflow: auto; max-height: 50vh; }
    .retrieved li{ margin:6px 0; }
    .dim { color:#64748b; font-size:12px }
  </style>
</head>
<body>
<h1>RAG 분석 실행</h1>

<div class="grid">
  <!-- 왼쪽: 폼 -->
  <div class="card">
    <form id="analyzeForm">
      <div class="row">
        <label for="userId">userId</label>
        <input id="userId" name="userId" type="number" value="1" required />
      </div>
      <div class="row">
        <label for="resumeFile">자소서 파일</label>
        <input id="resumeFile" name="resumeFile" type="file" required />
      </div>
      <div class="row">
        <label for="jobUrl">채용공고 URL</label>
        <input id="jobUrl" name="jobUrl" type="url" placeholder="https://..." required />
      </div>
      <div class="row">
        <label for="collection">컬렉션</label>
        <input id="collection" name="collection" type="text" value="accepted-essays" />
      </div>
      <div class="row">
        <label for="topK">topK</label>
        <input id="topK" name="topK" type="number" min="1" max="20" value="5" />
      </div>
      <div class="row" style="grid-template-columns: 1fr;">
        <button type="submit" id="analyzeBtn">분석 실행</button>
      </div>
      <p class="hint">서버와 동일 오리진에서 열면 CORS 설정 없이 동작합니다.</p>
    </form>
  </div>

  <!-- 오른쪽: 결과들 -->
  <div class="cols">
    <!-- 요약/메타 + RAG 검색 결과 -->
    <div class="card">
      <h3 style="margin:0 0 10px">요약 & 검색 결과</h3>
      <ul class="kvs" id="meta"></ul>
      <h4 style="margin:10px 0 6px">검색된 문서 (retrieved)</h4>
      <ol id="retrieved" class="retrieved"></ol>
      <p class="dim" id="retrievedEmpty" style="display:none">검색 결과가 비었습니다.</p>
    </div>

    <!-- 분석 내용 (LLM) -->
    <div class="card">
      <h3 style="margin:0 0 10px">분석 내용</h3>
      <div id="analysis" class="mono" style="min-height:200px;">(아직 없음)</div>
    </div>

    <!-- 원본 응답(JSON) -->
    <div class="card" style="grid-column: 1 / -1;">
      <h3 style="margin:0 0 10px">원본 응답(JSON)</h3>
      <pre id="analyzeOut" class="mono" style="margin:0;">(요청 전)</pre>
    </div>
  </div>
</div>

<script>
  const qs = id => document.getElementById(id);

  function setMeta(data) {
    const meta = qs('meta');
    meta.innerHTML = '';
    const rows = [
      ['ok', String(data.ok)],
      ['userId', data.userId],
      ['collection', data.collection],
      ['topK', data.topK],
      ['resumePreview', data.resumePreview],
      ['postingPreview', data.postingPreview],
    ];
    rows.forEach(([k,v]) => {
      if (v === undefined || v === null || v === '') return;
      const li = document.createElement('li');
      li.innerHTML = `<strong>${k}</strong>: ${typeof v === 'string' ? v : JSON.stringify(v)}`;
      meta.appendChild(li);
    });
  }

  function setRetrieved(list) {
    const ol = qs('retrieved');
    const empty = qs('retrievedEmpty');
    ol.innerHTML = '';
    if (!Array.isArray(list) || list.length === 0) {
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';
    list.forEach((r, i) => {
      const li = document.createElement('li');
      const dist = (typeof r.distance === 'number') ? r.distance.toFixed(4) : r.distance;
      li.innerHTML = `
        <div><strong>#${i+1}</strong> <span class="dim">id:</span> ${r.id ?? ''} <span class="dim">distance:</span> ${dist ?? ''}</div>
        <div>${(r.textPreview ?? '').replace(/\n/g,' ')}</div>
      `;
      ol.appendChild(li);
    });
  }

  function setAnalysis(text) {
    qs('analysis').textContent = text ? String(text) : '(분석 없음)';
  }

  function setRaw(raw) {
    const out = qs('analyzeOut');
    try { out.textContent = JSON.stringify(raw, null, 2); }
    catch { out.textContent = String(raw); }
  }

  qs('analyzeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = qs('analyzeBtn');
    btn.disabled = true;
    setAnalysis('요청 중...');
    setRaw('요청 중...');

    try {
      const fd = new FormData();
      fd.append('userId', qs('userId').value);
      fd.append('resumeFile', qs('resumeFile').files[0]);
      fd.append('jobUrl', qs('jobUrl').value);
      fd.append('collection', qs('collection').value);
      fd.append('topK', qs('topK').value);

      const res = await fetch('/api/flow/analyze', { method: 'POST', body: fd });
      const text = await res.text();
      let data = text;
      try { data = JSON.parse(text); } catch {}

      // 화면에 반영
      if (typeof data === 'object' && data) {
        setMeta(data);
        setRetrieved(data.retrieved);
        setAnalysis(data.analysis);
        setRaw(data);
      } else {
        setAnalysis('(서버가 JSON 대신 텍스트를 반환)');
        setRaw(text);
      }
    } catch (err) {
      setAnalysis('(에러 발생)');
      setRaw('에러: ' + err);
    } finally {
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
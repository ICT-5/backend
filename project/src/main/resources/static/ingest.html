<!-- src/main/resources/static/ingest.html -->
<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>합격 자소서 업로드 & 백필</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Malgun Gothic',sans-serif}
        body{margin:24px;background:#f8fafc;color:#0f172a}
        h1{margin:0 0 16px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
        .row{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:center;margin-bottom:10px}
        label{font-weight:600;color:#334155}
        input[type="text"],input[type="number"],input[type="url"]{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;background:#fff}
        input[type="file"]{width:100%}
        button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
        button.secondary{background:#0f766e}
        button:disabled{opacity:.6;cursor:not-allowed}
        .hint{font-size:12px;color:#64748b}
        pre{white-space:pre-wrap;word-break:break-word;background:#0b1020;color:#e2e8f0;padding:14px;border-radius:10px;overflow:auto;max-height:50vh}
    </style>
</head>
<body>
<h1>합격 자소서 업로드 & 백필</h1>

<div class="grid">
    <!-- (1) 엑셀 업로드 & 인덱싱 -->
    <section class="card">
        <h2 style="margin-top:0">엑셀 업로드 → /api/ingest/excel</h2>
        <div class="row">
            <label for="file">Excel 파일</label>
            <input id="file" type="file" accept=".xlsx,.xls" />
        </div>
        <div class="row">
            <label for="tag">Source Tag</label>
            <input id="tag" type="text" placeholder="예: PASS_SAMPLE" value="PASS_SAMPLE" />
        </div>
        <div class="row" style="grid-template-columns:1fr">
            <button id="btnUpload">업로드 & 인덱싱</button>
        </div>
        <p class="hint">서버와 동일 오리진에서 열면 CORS 설정 없이 동작합니다.</p>
        <pre id="outUpload"></pre>
    </section>

    <!-- (2) 백필(임베딩 생성 & 업서트) -->
    <section class="card">
        <h2 style="margin-top:0">백필 실행 → /api/admin/chroma/backfill-accepted</h2>
        <form id="backfillForm">
            <div class="row">
                <label for="bfCollection">컬렉션</label>
                <input id="bfCollection" name="collection" type="text" value="accepted-essays" />
            </div>
            <div class="row">
                <label for="bfPageSize">pageSize</label>
                <input id="bfPageSize" name="pageSize" type="number" value="100" />
            </div>
            <div class="row">
                <label for="bfMaxDocs">maxDocs</label>
                <input id="bfMaxDocs" name="maxDocs" type="number" value="0" />
            </div>
            <div class="row" style="grid-template-columns:1fr">
                <button type="submit" class="secondary" id="backfillBtn">백필 실행</button>
            </div>
        </form>
        <p class="hint">초기 1회 실행(또는 새 문서 추가 시 재실행)하면 됩니다.</p>
        <pre id="outBackfill"></pre>
    </section>
</div>

<script>
    const $ = (s) => document.querySelector(s);

    // (1) 엑셀 업로드 & 인덱싱
    $("#btnUpload").onclick = async () => {
        const f = $("#file").files[0];
        if (!f) { alert("엑셀 파일을 선택하세요"); return; }
        const fd = new FormData();
        fd.append("file", f);
        fd.append("sourceTag", $("#tag").value || "PASS_SAMPLE");

        const out = $("#outUpload");
        out.textContent = "업로드 중...";
        const btn = $("#btnUpload");
        btn.disabled = true;

        try {
            const res = await fetch("/api/ingest/excel", { method: "POST", body: fd });
            const txt = await res.text();
            try { out.textContent = JSON.stringify(JSON.parse(txt), null, 2); }
            catch { out.textContent = txt; }
        } catch (e) {
            out.textContent = String(e);
        } finally {
            btn.disabled = false;
        }
    };

    // (2) 백필 실행
    $("#backfillForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const out = $("#outBackfill");
        out.textContent = "요청 중...";
        const btn = $("#backfillBtn");
        btn.disabled = true;

        const params = new URLSearchParams({
            collection: $("#bfCollection").value,
            pageSize: $("#bfPageSize").value,
            maxDocs: $("#bfMaxDocs").value,
        });

        try {
            const res = await fetch("/api/admin/chroma/backfill-accepted?" + params.toString(), {
                method: "POST" // 컨트롤러가 POST 매핑이라면 그대로 사용
            });
            const text = await res.text();
            try { out.textContent = JSON.stringify(JSON.parse(text), null, 2); }
            catch { out.textContent = text; }
        } catch (err) {
            out.textContent = "에러: " + err;
        } finally {
            btn.disabled = false;
        }
    });
</script>
</body>
</html>

